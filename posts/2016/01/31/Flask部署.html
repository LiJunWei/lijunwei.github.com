<!DOCTYPE html>
<html lang="zh">
<head>
	<link rel="stylesheet" type="text/css" href="http://lijunwei.github.io/theme/css/style.css">
	<!--<link rel="stylesheet/less" type="text/css" href="/theme/css/style.less">-->
	<!--<script src="/theme/js/less.js" type="text/javascript"></script>-->
	<link rel="stylesheet" type="text/css" href="http://lijunwei.github.io/theme/css/pygments.css">
	<link href='//fonts.googleapis.com/css?family=Open+Sans:800,400,300|Inconsolata' rel='stylesheet' type='text/css'>

	<link href="http://lijunwei.github.io//" type="application/atom+xml" rel="alternate" title="李俊伟-随笔 ATOM Feed" />


		<title>李俊伟-随笔</title>
		<meta charset="utf-8" />
</head>
<body>
	<section id="sidebar">
		<figure id="user_logo">
            <a href="http://lijunwei.github.io"><div class="logo">&nbsp;</div></a>
		</figure>

		<div class="user_meta">
            <h1 id="user"><a href="http://lijunwei.github.io" class="">李俊伟</a></h1>
			<h2></h2>
			<p class="bio">专注Python开发，DevOps</p>
			<ul>
					<li><a href="http://lijunwei.github.io/">Home</a></li>
					<li><a href="https://github.com/LiJunWei/">GitHub</a></li>
					<li><a href="http://weibo.com/p/1005053201246451/home">微博</a></li>
			</ul>
		</div>
		<footer>
			<address>
				Powered by <a href="http://pelican.notmyidea.org/">Pelican</a>,
		                theme by <a href="https://github.com/wting/pelican-svbtle">wting</a>.
			</address>
		</footer>
	</section>

	<section id="posts">
	<header>
		<h1>李俊伟's blog</h1>
		<h3>Posted 2016-01-31</h3>
	</header>
	<article>
		<h1 id="title">
			<a href="http://lijunwei.github.io/posts/2016/01/31/Flask部署.html" rel="bookmark"
				title="Permalink to Flask部署">Flask部署</a>
		</h1>
		<h2>前言</h2>
<p>开发完公司的redis数据库运维平台，接下来就是要部署测试，之前没真正部署过，这次正好学习了，写下来部署的过程，本地虚拟机部署在了Ubuntu上，服务器是CentOS，不过大同小异。话不多说，以下是详细过程。</p>
<h2>配置Python虚拟环境</h2>
<p>先安装Python2.7  </p>
<div class="highlight"><pre>wget http://python.org/ftp/python/2.7/Python-2.7.tar.bz2 
tar -jxvf Python-2.7.tar.bz2   
cd Python-2.7
./configure  后面可以加上你希望安装的路径 比如 --prefix=/usr/local ，默认是/usr/local   
make &amp; make install   
make clean &amp; make distclean
</pre></div>


<p>安装pip，virtualenv <br />
因为系统默认是python2.6的，所以通过yum安装的pip会默认装到2.6的目录下，而且yum还依赖2.6所以没法直接修改系统默认的python来使用yum，因此我通过distribute的方式安装easy_install继而安装pip。   </p>
<div class="highlight"><pre>wget https://pypi.python.org/packages/source/d/distribute/distribute-0.6.49.tar.gz      
python distribute_setup.py #注意这里的python一定是你python2.7的路径下的python      
mkdir myproject   
cd myproject   
virtualenv venv
</pre></div>


<p>安装需要的包   </p>
<div class="highlight"><pre>pip install -r requirements.txt
</pre></div>


<p>安装gunicorn  </p>
<div class="highlight"><pre>pip install gunicorn
</pre></div>


<p>安装supervisor   </p>
<div class="highlight"><pre>pip install supervisor
pip freeze &gt; requirements.txt
每次pip安装了新的库之后都要freeze一次，这是个好习惯
</pre></div>


<h2>配置supervisor</h2>
<div class="highlight"><pre>echo_supervisord_conf &gt; supervisor.conf   # 生成 supervisor 默认配置文件
</pre></div>


<p>这个文件放在哪里都可以，只要你执行supervisor的时候指定它就可以，但还是建议放到/etc下，这样好管理</p>
<div class="highlight"><pre>[include]      
files = /home/junweil/my_etc/supervisor/conf.d/*.conf
</pre></div>


<p>下面是gunicorn的配置，命名为**.conf,放在supervisor/conf.d里面
在supervisor.conf的最下面有两行，这里是表示会include进来的其他配置文件，我们应用的gunicorn，celery等的配置就应该放到 <br />
supervisor/conf.d中。  </p>
<div class="highlight"><pre><span class="k">[program:wsgi]</span>
<span class="na">command</span><span class="o">=</span><span class="s">/home/myproject/venv/bin/python/gunicorn -w 4 -b 0.0.0.0:5500 wsgi:app</span>
<span class="na">directory</span><span class="o">=</span><span class="s">/home/myproject</span>
<span class="na">startsecs</span><span class="o">=</span><span class="s">0</span>
<span class="na">stopwaitsecs</span><span class="o">=</span><span class="s">0</span>
<span class="na">autostart</span><span class="o">=</span><span class="s">false</span>
<span class="na">autorestart</span><span class="o">=</span><span class="s">false</span>
<span class="na">stdout_logfile</span><span class="o">=</span><span class="s">/home/my_log/gunicorn/gunicorn.log</span>
<span class="na">stderr_logfile</span><span class="o">=</span><span class="s">/home/my_log/gunicorn/gunicorn.err</span>
</pre></div>


<p>下面是celery的配置，同gunicorn一样，我们的项目用到celery做异步消息的处理，如果不需要用到的可以忽略 </p>
<div class="highlight"><pre><span class="k">[program:celery]</span>
<span class="na">command</span><span class="o">=</span><span class="s">/home/myproject/venv/bin/python/celery worker -A app.celery --loglevel=info</span>
<span class="na">environment</span><span class="o">=</span><span class="s">PYTHONPATH=/home/myproject</span>
<span class="na">directory</span><span class="o">=</span><span class="s">/home/myproject</span>
<span class="na">user</span><span class="o">=</span><span class="s">junweil</span>
<span class="na">numprocs</span><span class="o">=</span><span class="s">1</span>
<span class="na">stdout_logfile</span><span class="o">=</span><span class="s">/home/my_log/celery/celeryd.log</span>
<span class="na">stderr_logfile</span><span class="o">=</span><span class="s">/home/my_log/celery/celeryd.err</span>
<span class="na">autostart</span><span class="o">=</span><span class="s">true</span>
<span class="na">autorestart</span><span class="o">=</span><span class="s">true</span>
<span class="na">startsecs</span><span class="o">=</span><span class="s">10</span>
</pre></div>


<h2>安装nginx</h2>
<div class="highlight"><pre>CentOS yum install nginx
Ubuntu apt-get install nginx
</pre></div>


<p>配置nginx</p>
<div class="highlight"><pre>    <span class="nt">server</span> <span class="p">{</span>
        <span class="n">listen</span>   <span class="m">80</span><span class="p">;</span>
        <span class="n">root</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">myproject</span><span class="o">/</span><span class="n">app</span><span class="p">;</span>
        <span class="n">server_name</span> <span class="n">alpaca</span><span class="o">.</span><span class="n">jumeird</span><span class="o">.</span><span class="n">com</span><span class="p">;</span>
        <span class="n">location</span> <span class="o">/</span> <span class="err">{</span>
            <span class="n">proxy_pass</span>  <span class="n">http</span><span class="o">://</span><span class="m">127</span><span class="o">.</span><span class="m">0</span><span class="o">.</span><span class="m">0</span><span class="o">.</span><span class="m">1</span><span class="o">:</span><span class="m">5500</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nt">location</span> <span class="o">~*/</span><span class="nt">static</span><span class="o">/</span> <span class="p">{</span>
            <span class="n">root</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">myproject</span><span class="o">/</span><span class="n">app</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="err">}</span>
</pre></div>


<h2>启动supervisor和nginx</h2>
<p>运行命令<code>supervisord -c supervisor.conf</code>启动supervisor <br />
supervisor相关命令  </p>
<div class="highlight"><pre>supervisord -c supervisor.conf                          通过配置文件启动supervisor
supervisorctl -c supervisor.conf status                 察看supervisor的状态
supervisorctl -c supervisor.conf reload                 重新载入 配置文件
supervisorctl -c supervisor.conf start [all]|[appname]  启动指定/所有 supervisor管理的程序进程
supervisorctl -c supervisor.conf stop [all]|[appname]   关闭指定/所有 supervisor管理的程序进程
</pre></div>


<p>启动nginx</p>
<div class="highlight"><pre>nginx -c /etc/nginx/nginx.conf
</pre></div>


<p>nginx相关命令</p>
<div class="highlight"><pre>nginx -t 验证配置文件是否正确
nginx -s reload 重新载入配置文件，并重启
</pre></div>


<p>在服务器上是nginx1.8版本的，我在自己虚拟机上实验的时候用的nginx1.9版本只要把配置文件放到sites-available文件夹中，并在sites-enabled中建立软连接指向sites-available文件夹中对应的配置文件即可。然后直接service nginx restart或/etc/init.d/nginx start</p>
<h2>flask启动文件</h2>
<div class="highlight"><pre><span class="c"># coding: utf-8</span>

<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">create_app</span><span class="p">,</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">()</span>


<span class="nd">@app.errorhandler</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">not_found</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;error/404.html&#39;</span><span class="p">),</span> <span class="mi">404</span>


<span class="nd">@app.errorhandler</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">not_found</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;error/500.html&#39;</span><span class="p">),</span> <span class="mi">500</span>


<span class="nd">@app.teardown_request</span>
<span class="k">def</span> <span class="nf">shutdown_session</span><span class="p">(</span><span class="n">exception</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>


<span class="nd">@app.teardown_appcontext</span>
<span class="k">def</span> <span class="nf">shutdown_session</span><span class="p">(</span><span class="n">exception</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>

		<div id="article_meta">
				Category:
					<a href="http://lijunwei.github.io/category/pythonflask.html">Python，Flask</a>
				<br />Tags:
					<a href="http://lijunwei.github.io/tag/pythonflask.html">Python，Flask</a>
		</div>
	</article>

	<footer>
		<a href="http://lijunwei.github.io/" class="button_accent">&larr;&nbsp;&nbsp;&nbsp;Back to blog</a>
	</footer>


	</section>

</body>
</html>